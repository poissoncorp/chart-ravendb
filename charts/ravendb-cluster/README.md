[![Artifact Hub](https://img.shields.io/endpoint?url=https://artifacthub.io/badge/repository/ravendb-cluster)](https://artifacthub.io/packages/search?repo=ravendb-cluster)
# Secured RavenDB Cluster Helm Chart ☸️

## Overview
This Helm chart provides all necessary components for the secured RavenDB cluster. It's very easy to deploy & manage your own RavenDB cluster by using it.

## Prerequisites 
- RavenDB License (obtained via https://ravendb.net - also works with the free developer license)
- The [rvn](https://github.com/ravendb/ravendb/tree/v5.4/tools/rvn) - it generates proper *setup package* and *values.yaml* for you 

- *Alternativelly you could get package via the setup wizard or write values.yaml by yourself, but we highly recommend using the script*

## Installation

By *cloning* the repo

`git clone https://github.com/ravendb/helm-charts.git`

`helm install [name] [chart path] --set-file package=[setup/package/path] -f [values/yaml/path]`

the chart is located under the `charts/ravendb-cluster` directory

---
or **via [artifacthub.io](https://artifacthub.io/packages/helm/ravendb-cluster/ravendb)**

`helm repo add ravendb-cluster https://ravendb.github.io/helm-charts/charts/ravendb-cluster/package/`

`helm install [name] ravendb-cluster/ravendb --set-file package=[setup/package/path] -f [values/yaml/path]`

---
Before installation you should run [rvn](https://github.com/ravendb/ravendb/tree/v5.4/tools/rvn) to generate helm **values.yaml** and a **setup package**:

`rvn create-setup-package -m=[setup-mode] -s="[path/to/create-setup-package-setup.json]" -o=[package output path] --generate-helm-values [yaml output path] `

---
Then, you might want to customize generated `values.yaml`, where you can:
- Enter how big should be `storageSize` on each node.

- Provide custom `ingressClassName` (e.g. haproxy...)

- Select desired RavenDB image tag. It is `latest` by default, but we don't recommend keeping it on production (due to its' floating nature), [tags on DockerHub](https://hub.docker.com/r/ravendb/ravendb/tags)

- In some cases you might want to edit [image pull policy](https://kubernetes.io/docs/concepts/containers/images/#image-pull-policy).

- If you need some environmental values inside the RavenDB container, you can define them in the `environment` map.

### Example values.yaml

```yaml
# customizable
storageSize: 5Gi
ravenImageTag: latest
imagePullPolicy: IfNotPresent
ingressClassName: nginx

# these values are generated by the script and shouldn't be changed
nodeTags:
- A
- B
- C
domain: "ravendb.poisson.net"
email: user@example.net
setupMode: LetsEncrypt
license: < license json >

# optional, for hackers
environment:
  SOME_ENV_VALUE: 'foo'
  SOME_OTHER_ENV_VALUE: 'bar'
```
 

---
## How do I make this work?
---
## Configure your DNS 

Make sure that your DNS contains records that translate RavenDB nodes addresses to the ingress controller IP address. Pods need these to talk to each self. You need to translate 
- `<nodeTag>.[domain]`
- `<nodeTag>-tcp.[domain]`

names to ingress controller IP address.


*e.g. Additional record inside /etc/hosts file, `192.168.1.15` is my local IP address, running nginx on local machine k8s cluster*

```
192.168.1.15 a.raven.domain.com b.raven.domain.com c.raven.domain.com 
192.168.1.15 a-tcp.raven.domain.com b-tcp.raven.domain.com c-tcp.raven.domain.com 
```

*Dns records can't point to localhost/loopback/0.0.0.0, basically it'll tell the pods to reach nginx on themselves, not on our machine - use your local IP address.*

---
## Set up your ingress controller

It must be able to **passthrough SSL** like Nginx/HAProxy.


### NGINX

Use `--enable-ssl-passthrough` option.


If you've deployed k8s nginx before, its dependencies are frequently stored in the 'ingress-nginx' namespace.
You can deploy nginx to k8s using the `nginx-ingress-ravendb.yaml` file located in the misc folder, which is preconfigured for default nodes/tags/ports and secured connection.
It is not necessary, but running `kubectl delete all --all -n ingress-nginx` should delete all nginx k8s depts before another deployment.
Run `kubectl apply -f [path to 'nginx-ingress-ravendb' file]` to either update or install well configured nginx ingress controller locally.

If you want to configure it manually, make sure that...
- ... port 38888 (or your own ServerUrl_Tcp port) is exposed on the nginx controller pod
- ... --enable-ssl-passthrough is set (when working with secured cluster)

### HAProxy, Traefik and others

Change the `ingressClassName` in the `values.yaml`, enter your deployed ingress class name.

e.g. `ingressClassName: haproxy`

**Remember to enable SSL passtrough on your ingress controller**

https://doc.traefik.io/traefik/routing/routers/#passthrough

https://serversforhackers.com/c/using-ssl-certificates-with-haproxy


## Rolling updates

You can perform rolling update using the `rolling-update.sh` script located in the `/scripts` directory. Provide desired RavenDB image tag from the DockerHub https://hub.docker.com/r/ravendb/ravendb/tags as the first arg and path to the Helm chart as the second.

`./rolling-update.sh latest ~/ravendb-cluster`

It'll execute rolling update strategy and update your pods image tags.
